# [羊城杯 2020]Power

task.py

```py
from Crypto.Util.number import *
import gmpy2
from secret import flag

p = getPrime(512)
q = getPrime(512)
n = p**4*q

e = 0x10001
phi = gmpy2.lcm(p - 1, q - 1)
d = gmpy2.invert(e, phi)
dp = d % (p - 1)
m = bytes_to_long(flag)
c = pow(m, e, n)
print "dp = " + str(dp)
print "c = " + str(c)

y = 449703347709287328982446812318870158230369688625894307953604074502413258045265502496365998383562119915565080518077360839705004058211784369656486678307007348691991136610142919372779782779111507129101110674559235388392082113417306002050124215904803026894400155194275424834577942500150410440057660679460918645357376095613079720172148302097893734034788458122333816759162605888879531594217661921547293164281934920669935417080156833072528358511807757748554348615957977663784762124746554638152693469580761002437793837094101338408017407251986116589240523625340964025531357446706263871843489143068620501020284421781243879675292060268876353250854369189182926055204229002568224846436918153245720514450234433170717311083868591477186061896282790880850797471658321324127334704438430354844770131980049668516350774939625369909869906362174015628078258039638111064842324979997867746404806457329528690722757322373158670827203350590809390932986616805533168714686834174965211242863201076482127152571774960580915318022303418111346406295217571564155573765371519749325922145875128395909112254242027512400564855444101325427710643212690768272048881411988830011985059218048684311349415764441760364762942692722834850287985399559042457470942580456516395188637916303814055777357738894264037988945951468416861647204658893837753361851667573185920779272635885127149348845064478121843462789367112698673780005436144393573832498203659056909233757206537514290993810628872250841862059672570704733990716282248839
g = 2
x = 2019*p**2 + 2020*p**3 + 2021*p**4
c1 = pow(g, x, y)
print "c1 = " + str(c1)

# dp = 3272293505696712831419859641571956066667516012597886098021642320155056349966612629986261146617139998624603483170466852538289743936225789351270153550594329
# c = 22524257534087703614496632403022329621384173069680778965750290698059674588465640878754707363673789674111671270645152584118206145007310499274423606886261969807360070526126452646719628307689968971699215841867636770320159256301550908771135042912287955209485328267670825390080110910391913063177323585204392804538642393453388536211144485389902591029350060800993352969569703901717308330574394200996651534321547814313195218895547718815009876393987398738932001924661338796059973950012706427109598830049455186171345179840564502215531573714428772608739268313985559628612004439028014417408631851880698512023740903181116906766066951473942201698375224240271523568161242951730224901227589413731025281719101368668617497947995579443908773425555177346524678673641140157885033923288401884
# c1 = 290707924192892686920253390955676600323331633814839708838347288502692494699485764473635783441705302268064111648851157070038783719749721994682837294625334517914882191486257362565066745587415388291939979195637720350919055988532145531805200483161599965215275808797976727969023747299578173497083532351976473770041800769265319548352841139802163279116490053292316399038329210043455932786945180855178341998049756983301499491011851026499269682821602212971062877270127451987836730083380463825717889123804613394241190839837791281657872259492589868751745327696030438893865069941066073554427558697972551085353027574529823439588670263047287131740802375738439636789806332323994866753085014446479034974063195632514803340511247735647970572837053148490258113394359072976858781060349776921428492973183958437965966963122069107876143476772436757554253049619918403996315720023020827394900507088006299225934263699192253079026440287311664705744424959801981503191480257138833694306501816837037995549817186335377411638035575004595417788588264823861850877111374085336446477943372458378834664678094751978400910288151519902977326995118727880223621964441498323865158898463327323193833062919619201107279964663654606753750042791368210261574897455830722232022689695292080269205470491791950839486861811469879413313773338916781857981641910031441448964144000585506870170898052132929034349451945051362244755750988705018897859238859476967568556992146975789444151432386692872801263000639711599152191790766776280

```

首先观察

```py
x = 2019*p**2 + 2020*p**3 + 2021*p**4
c1 = pow(g, x, y)
```

先用离散对数求出 x 的值。  
此处使用 sympy 库的 discrete_log 函数。  

```py
x = sympy.discrete_log(y,c1,2) # g ^ x mod y = c1
```

需要大概三分钟跑出结果。  
然后解方程 `x = 2019*p**2 + 2020*p**3 + 2021*p**4`  
用 sage 解方程。  

```py
p = PolynomialRing(ZZ, 'p').gen()
f = 2019*p**2 + 2020*p**3 + 2021*p**4 -x
f.roots()
# p = 7234391427703598327916723159145232922047935397302241978344500497098972068808591685717500902909442183573763273395725479516998210374727754578133587007330339
```

由于题中只给出了 dp 和可计算出的 p，由 CRT 可以推得  
$c^d\ mod\ n$  
$m1=c^d\ mod\ p$  
令  
$d = k(p-1) + r$  
则  
$c^d\ mod\ p$  
$=c^{k(p-1) + r}\ mod\ p$  
$=c^r * c^{k(p-1)}\ mod\ p$  
因为 $c^{p-1}\ mod\ p = 1$ （欧拉定理）  
$c^d\ mod\ p=c^r\ mod\ p$  
r 是 d 除 p-1 的余数，即 r = d mod (p-1)  
所以 $c^d\ mod\ p$可以降阶为 $c^{(d\ mod\ p-1)}\ mod\ p$  
也即
$c^{dp}\equiv c^d\  mod\ p$  
而当 $m < p$ 时，$m\ mod\ p=m1=m$  
此时通过 $m = c^{dp}\ mod\ p$ 即可解得 $m$  

exp

```py
from Crypto.Util.number import *
import gmpy2
import sympy

dp = 3272293505696712831419859641571956066667516012597886098021642320155056349966612629986261146617139998624603483170466852538289743936225789351270153550594329
c = 22524257534087703614496632403022329621384173069680778965750290698059674588465640878754707363673789674111671270645152584118206145007310499274423606886261969807360070526126452646719628307689968971699215841867636770320159256301550908771135042912287955209485328267670825390080110910391913063177323585204392804538642393453388536211144485389902591029350060800993352969569703901717308330574394200996651534321547814313195218895547718815009876393987398738932001924661338796059973950012706427109598830049455186171345179840564502215531573714428772608739268313985559628612004439028014417408631851880698512023740903181116906766066951473942201698375224240271523568161242951730224901227589413731025281719101368668617497947995579443908773425555177346524678673641140157885033923288401884
c1 = 290707924192892686920253390955676600323331633814839708838347288502692494699485764473635783441705302268064111648851157070038783719749721994682837294625334517914882191486257362565066745587415388291939979195637720350919055988532145531805200483161599965215275808797976727969023747299578173497083532351976473770041800769265319548352841139802163279116490053292316399038329210043455932786945180855178341998049756983301499491011851026499269682821602212971062877270127451987836730083380463825717889123804613394241190839837791281657872259492589868751745327696030438893865069941066073554427558697972551085353027574529823439588670263047287131740802375738439636789806332323994866753085014446479034974063195632514803340511247735647970572837053148490258113394359072976858781060349776921428492973183958437965966963122069107876143476772436757554253049619918403996315720023020827394900507088006299225934263699192253079026440287311664705744424959801981503191480257138833694306501816837037995549817186335377411638035575004595417788588264823861850877111374085336446477943372458378834664678094751978400910288151519902977326995118727880223621964441498323865158898463327323193833062919619201107279964663654606753750042791368210261574897455830722232022689695292080269205470491791950839486861811469879413313773338916781857981641910031441448964144000585506870170898052132929034349451945051362244755750988705018897859238859476967568556992146975789444151432386692872801263000639711599152191790766776280

y = 449703347709287328982446812318870158230369688625894307953604074502413258045265502496365998383562119915565080518077360839705004058211784369656486678307007348691991136610142919372779782779111507129101110674559235388392082113417306002050124215904803026894400155194275424834577942500150410440057660679460918645357376095613079720172148302097893734034788458122333816759162605888879531594217661921547293164281934920669935417080156833072528358511807757748554348615957977663784762124746554638152693469580761002437793837094101338408017407251986116589240523625340964025531357446706263871843489143068620501020284421781243879675292060268876353250854369189182926055204229002568224846436918153245720514450234433170717311083868591477186061896282790880850797471658321324127334704438430354844770131980049668516350774939625369909869906362174015628078258039638111064842324979997867746404806457329528690722757322373158670827203350590809390932986616805533168714686834174965211242863201076482127152571774960580915318022303418111346406295217571564155573765371519749325922145875128395909112254242027512400564855444101325427710643212690768272048881411988830011985059218048684311349415764441760364762942692722834850287985399559042457470942580456516395188637916303814055777357738894264037988945951468416861647204658893837753361851667573185920779272635885127149348845064478121843462789367112698673780005436144393573832498203659056909233757206537514290993810628872250841862059672570704733990716282248839
g = 2
#P.<x> = PolynomialRing(Zmod(y))
#f = 2 ** (2019*p**2 + 2020*p**3 + 2021*p**4)
# x = sympy.discrete_log(y,c1,2) # g ^ x mod y = c1
# print(x)
x = 5535722692962580764045545539105119140941061679289569420988353884209653851308860058948669740693107863231179565602072744542122031789184119031739723962825082929025825322421201364211726001366490949760887367407718763255964735567971493859197583624076478457865073449246835949075135223468616834636386958924709024763349115622062848212445867198457630368236782421195503713107838541903829979118327675371550868768159024260793541264335548489228744367609071659968450303895118817379316060805148754136917043160175570565717388336822960389664337656603584425629662613786203920234401824957121860225422901340950436355650311392398098947210940

p = PolynomialRing(ZZ, 'p').gen()
f = 2019*p**2 + 2020*p**3 + 2021*p**4 -x
f.roots()
p = 7234391427703598327916723159145232922047935397302241978344500497098972068808591685717500902909442183573763273395725479516998210374727754578133587007330339
print(long_to_bytes(int(pow(c, dp, p))))

```  

## 最后

主要到本题中  

```py
p = getPrime(512)
q = getPrime(512)
n = p**4*q

e = 0x10001
phi = gmpy2.lcm(p - 1, q - 1)
```

~~若是标准欧拉函数求 phi 的值应该是 $p^3(p-1)(q-1)$~~  
~~而这里却不是，而且居然不影响 RSA 的解密，对此经过思考，写下一点不尽严谨的证明。~~  
~~在标准 RSA 解密的过程中，主要依赖于欧拉定理。  
欧拉定理：~~
~~$若 gcd(a,m)=1，则满足 a^{φ(m)}≡1(mod\ m)$~~  
其证明参见 <https://www.cnblogs.com/1024th/p/11349355.html>~~  
~~这里不再赘述。~~
~~从证明中可以看到关键在于~~  

---
$设 [1,m) 内与 m 互质的数为数列 \{b_n\}=\{b_1,b_2,b_3,⋯,b_{φ(m)}\}$

$因为 a,m 互质且 b_i,m 互质，所以数列 {A_n}={ab_1,ab_2,ab_3,⋯,ab_{φ(m)}} 中每个数都与 m 互质，且两两不同。$

$同时，由 gcd(ab_i,m)=1 可得 gcd(ab_i\ mod\ m,m)=1，即每个 A_i 除以 m 的余数都与 m 互质，且余数两两不同。$

$可以用反证法推出“余数两两不同”。假设存在 ab_i≡ab_j(modm)，那么 ab_i−ab_j=km (k∈Z)，即 a(b_i−b_j)=km。由于 a 与 m 互质，那么只能是 m∣(b_i−b_j)，即 b_i≡b_j(mod\ m)。这与 1≤b_i,b_j<m 且 b_i≠b_j 的题设相违背，因此假设不成立。$

---

实际上是因为在明文 m < (p-1)(q-1) 时，  
$m^e\ mod\ p^3(p-1)(q-1) == m^e\ mod\ (p-1)(q-1)$  
$m^e$拆开即可证明，想了一下午发现自己完全走错了方向。  
这模数削减的想法每次都是好久才意识到，下次又得想好久，哎，还是不够熟练。  
