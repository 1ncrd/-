# CTF SR 23.05.06 - Incrd

## [CISCN 2022 西南] rsa

problem

```py
from Crypto.Util.number import *
import gmpy2

flag = b'XXXXXXXX'
p1 = getPrime(700)
r1 = getPrime(700)
for i in range(10):
    q1 = 5*p1+i
n = p1*q1*r1
p3 = pow(p1,3,n)
q3 = pow(q1,3,n)

print(p3)
print(q3)
'''
p3 = 29914513810588158800677413177910972738704129106546850855032986405861482276089830788972187432277517348644647399654780884571794069905291936470934226328931651386658328163535027343107140438177837479649822914209171476632450951930287641742344330471734177295804718555774395704231261550376220154493373703096062950390869299905383682611063374747752091585836452902373843865043412096365874638466683035848817858586173172058756256354758712684819253211761289032789542371351760915771791997388241121078055468403109260493642435791152671979552597191217179672328555740595434990908530985477314228867209314472001848844089467987561661918366232980944933533
q3 = 66208618374366130551979192465001581263127328176551695213970812805980115496523825511250542987452691413485117902772315362811067501379171731387904074565035353566976164797769439898266222919741874340315356585585077141595328441423323822407738375537476582506440045835592730211502035261968878999959340204806442390319739977816872969200022096331677277225467021553564212725120939434924481787524609852608476848761521446441776154400518315701988027274150425936061679275540502720782853648148897480117033152064922234451671636288396704170234613549011854618414776342798740690128675106027908639984431432591397555541420243824539205614036979987830125678
'''
P = getPrime(1024)
Q = getPrime(1024)
N = P * Q
E = 65537
lcm = gmpy2.lcm(P-1, Q-1)
e1 = gmpy2.invert(p1, lcm)
e2 = gmpy2.invert(r1, lcm)
m = bytes_to_long(flag)
c = pow(m, E, N)

print(lcm)
print(c)
print(N)
'''
lcm = 4292158730589770192682795435047249488185453170529228019750042608688907718268448193363838203887391025871515871000364259326343790645215256385842265899206372365402431198699714374850409466996627163968391249416054093529090485677808301343590811445080871279796162536469847469761747058736980603093722710824453312207182881241846080117790728778291633761198069016865260030288832065807438020772711645648333908622890343009942617559434851450007195025869850769670769715654662127278293639938359741401336592219730356884542179574372134014927006215640945952229142436595334916765255426954857520777553915330597952622785359222832224632624
c = 4288727484183191191687364666620023549392656794153112764357730676861570386983002380982803054964588111708662498647767438881892355599604826306427809017097724346976778230464708540600157055782723189971534549543664668430013171469625043063261219462210251726207552819381767396148632877168530609902046293626355744288863460554297860696918890189350721960355460410677203131993419723440382095665713164422367291153108363066159712951217816814873413423853338021627653555202253351957999686659021298525147460016557904084617528199284448056532965033560516083489693334373695545423561715471204868795248569806148395196572046378679014697206
N  = 17168634922359080770731181740188997952741812682116912079000170434755630873073792773455352815549564103486063484001457037305375162580861025543369063596825489461609724794798857499401637867986508655873564997664216374116361942711233205374363245780323485119184650145879389879046988234947922412374890843297813248828996855478005656041814919367820336728271583686844991928889831691815821365423570311291064846736832327637944358854661523107817781673029406341843040857813841671405147146887291204140157388049394514390098066284975682117038362207142272098796924412602725857521665773622056312191400612944442008222587867782281556388669
'''

```

`lcm = gmpy2.lcm(P-1, Q-1)`
$$ lcm = (P-1)(Q-1)/gcd $$

$$ \therefore lcm|(P-1)(Q-1) $$

$$ (P-1)(Q-1) \approx PQ = N$$

$$ (P-1)(Q-1) \approx N = k*lcm $$

$$ N // lcm = 4 $$

$$ (P-1)(Q-1) = 4* lcm $$

solve

```py
from Crypto.Util.number import *
import gmpy2
lcm = 4292158730589770192682795435047249488185453170529228019750042608688907718268448193363838203887391025871515871000364259326343790645215256385842265899206372365402431198699714374850409466996627163968391249416054093529090485677808301343590811445080871279796162536469847469761747058736980603093722710824453312207182881241846080117790728778291633761198069016865260030288832065807438020772711645648333908622890343009942617559434851450007195025869850769670769715654662127278293639938359741401336592219730356884542179574372134014927006215640945952229142436595334916765255426954857520777553915330597952622785359222832224632624
c = 4288727484183191191687364666620023549392656794153112764357730676861570386983002380982803054964588111708662498647767438881892355599604826306427809017097724346976778230464708540600157055782723189971534549543664668430013171469625043063261219462210251726207552819381767396148632877168530609902046293626355744288863460554297860696918890189350721960355460410677203131993419723440382095665713164422367291153108363066159712951217816814873413423853338021627653555202253351957999686659021298525147460016557904084617528199284448056532965033560516083489693334373695545423561715471204868795248569806148395196572046378679014697206
N = 17168634922359080770731181740188997952741812682116912079000170434755630873073792773455352815549564103486063484001457037305375162580861025543369063596825489461609724794798857499401637867986508655873564997664216374116361942711233205374363245780323485119184650145879389879046988234947922412374890843297813248828996855478005656041814919367820336728271583686844991928889831691815821365423570311291064846736832327637944358854661523107817781673029406341843040857813841671405147146887291204140157388049394514390098066284975682117038362207142272098796924412602725857521665773622056312191400612944442008222587867782281556388669
E = 65537

gcd = N // lcm # 4
lcm_factors = [2 ^ 4, 3 ^ 2, 29, 41, 28837, 539785469, 750776809, 2145108738395851870652351567318727930299771893859254555069465058250708318070541216163892903160663469858955192449891503514812916318998924567781147870073094652803046789694992832700569307417493014382335042214593183628549512630174754208364389541819897561101318305671600185644570177919275696220434711137647385050286794411586376963451102116565345681204018524060480322458934335491957258908906815572053204171175842382098719339800855187959078647179620875086242279394326662157005552367106569210060577941173068249807048301644562444481469344580656693056958047693644898167656621367808440252312082978807]
P_m_Q = lcm * 4
P_p_Q = N - P_m_Q + 1
delta = P_p_Q ** 2 - 4 * N
P = (P_p_Q + int(gmpy2.iroot(delta, 2)[0])) // 2
Q = N // P
assert N == P * Q

phi = lcm
d = inverse(E, phi)
m = pow(c, d, N)
print(long_to_bytes(m))
```

## Legendre 理论

Let $\xi$ be a positive real number. Suppose $gcd(a, b) = 1$ and

$$ |\xi - \frac{a}{b}| < \frac{1}{2b^2} $$

则对 $\xi$ 连分数展开可以得到某项 $a_i=\frac{a}{b} $

## [CISCN 2022 东北赛区] math 

task.py

```py
import gmpy2
from Crypto.Util.number import *
from flag import flag
assert flag.startswith(b"flag{")
assert flag.endswith(b"}")
message = bytes_to_long(flag)


def keygen(nbit, dbit):
    if 2*dbit < nbit:
        while True:
            a1 = getRandomNBitInteger(dbit)
            b1 = getRandomNBitInteger(nbit//2-dbit)

            n1 = a1*b1+1

            if isPrime(n1):
                break
        while True:
            a2 = getRandomNBitInteger(dbit)
            b2 = getRandomNBitInteger(nbit//2-dbit)

            n2 = a2*b2+1

            n3 = a1*b2+1
            if isPrime(n2) and isPrime(n3):
                break
        while True:
            a3 = getRandomNBitInteger(dbit)
            if gmpy2.gcd(a3, a1*b1*a2*b2) == 1:
                v1 = (n1-1)*(n2-1)  # phi1
                k = (a3*inverse(a3, v1)-1)//v1  # k * phi1 = k * v1 = ed - 1
                v2 = k*b1+1
                if isPrime(v2):
                    return a3, n1*n2, n3*v2


def encrypt(msg, pubkey):
    return pow(msg, pubkey[0], pubkey[1])


nbit = 1024
dbit = 256
e, n1, n2 = keygen(nbit, dbit)
print('e =', e)
print('n1 =', n1)
print('n2 =', n2)
c1 = encrypt(message, [e, n1])
c2 = encrypt(message, [e, n2])
print('enc1 =', c1)
print('enc2 =', c2)
# e = 86905291018330218127760596324522274547253465551209634052618098249596388694529
# n1 = 112187114035595515717020336420063560192608507634951355884730277020103272516595827630685773552014888608894587055283796519554267693654102295681730016199369580577243573496236556117934113361938190726830349853086562389955289707685145472794173966128519654167325961312446648312096211985486925702789773780669802574893
# n2 = 95727255683184071257205119413595957528984743590073248708202176413951084648626277198841459757379712896901385049813671642628441940941434989886894512089336243796745883128585743868974053010151180059532129088434348142499209024860189145032192068409977856355513219728891104598071910465809354419035148873624856313067
# enc1 = 71281698683006229705169274763783817580572445422844810406739630520060179171191882439102256990860101502686218994669784245358102850927955191225903171777969259480990566718683951421349181856119965365618782630111357309280954558872160237158905739584091706635219142133906953305905313538806862536551652537126291478865
# enc2 = 7333744583943012697651917897083326988621572932105018877567461023651527927346658805965099102481100945100738540533077677296823678241143375320240933128613487693799458418017975152399878829426141218077564669468040331339428477336144493624090728897185260894290517440392720900787100373142671471448913212103518035775
```

$$ a_3 = e, v_1 = \phi(n_1)$$

$$ d = inv(a_3, v_1) $$

$$ k = \frac{a_3*d-1}{v_1} $$

$$ \frac{n_1}{n_2} = \frac{(a_1b_1+1)(a_2b_2+1)}{(a_1b_2+1)(kb_1+1)} \approx \frac{a_1b_1a_2b_2}{a_1b_2kb_1} = \frac{a_2}{k} $$
因此对 $\frac{n_1}{n_2}$ 连分数展开以找到 $a_2,k$
$$ k\phi(n_1) = ed - 1$$

$$ k\phi(n_1) + 1 \mod e = 0 $$

$$ \phi(n_1) \mod a_2 = 0 $$

crt 可求 $$\phi(n_1) \mod ea_2$$

$$ |n_1-\phi(n_1)| = |(a_1b_1+1)(a_2b_2+1)-a_1b_1a_2b_2| = a_1b_1 + a_2b_2 + 1 \le 2^{513} $$

$e, a_2$ 均为 256 bit 整数， $ea_2$ 为 512 位， 故穷举 $(\phi(n_1) \mod ea_2) + (n_1 // ea_2) * ea_2 - iea_2, i \in [0, 10]$

```py
# sage
from Crypto.Util.number import long_to_bytes
from tqdm import tqdm
import gmpy2

N1 = 112187114035595515717020336420063560192608507634951355884730277020103272516595827630685773552014888608894587055283796519554267693654102295681730016199369580577243573496236556117934113361938190726830349853086562389955289707685145472794173966128519654167325961312446648312096211985486925702789773780669802574893
N2 = 95727255683184071257205119413595957528984743590073248708202176413951084648626277198841459757379712896901385049813671642628441940941434989886894512089336243796745883128585743868974053010151180059532129088434348142499209024860189145032192068409977856355513219728891104598071910465809354419035148873624856313067
e = 86905291018330218127760596324522274547253465551209634052618098249596388694529
enc1 = 71281698683006229705169274763783817580572445422844810406739630520060179171191882439102256990860101502686218994669784245358102850927955191225903171777969259480990566718683951421349181856119965365618782630111357309280954558872160237158905739584091706635219142133906953305905313538806862536551652537126291478865

c = continued_fraction(Integer(N2) / Integer(N1))
for i in tqdm(range(1, 211)):
    a2 = c.denominator(i)
    k = c.numerator(i)
    if gmpy2.gcd(k, e) != 1:
        continue
    tmp = gmpy2.invert(k, e)
    res = (-1 * tmp) % e
    phi_ = crt(res, 0, e, a2)
    mod = e * a2
    phi1 = phi_ + (N1 // mod) * mod # phi1

    for j in range(10):
        phi1 -= mod
        if gmpy2.gcd(e, phi1) != 1:
            continue
        d1 = gmpy2.invert(e, phi1)
        flag = long_to_bytes(gmpy2.powmod(enc1, d1, N1))
        if b"flag{" in flag and b"}" in flag:
            print(flag)
```
